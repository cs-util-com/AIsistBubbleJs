<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BabyStepsJs</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden;
      background-color: #1e1e2f; font-family: Arial, sans-serif;
    }
    .top-panel {
      position: absolute; width: 100%; text-align: center; top: 10px; z-index: 999;
      color: white; font-size: 14px; display: flex; justify-content: center;
      align-items: center; flex-wrap: wrap; gap: 20px;
    }
    .top-panel input[type="date"] {
      color: black; padding: 5px 8px; border-radius: 5px; border: none;
    }
    .top-panel button {
      cursor: pointer; padding: 5px 10px; border-radius: 5px; border: none;
      background-color: #4caf50; color: white; font-weight: bold;
    }
    .top-panel button:hover { background-color: #388e3c; }
    svg {
      width: 100%; height: 100vh; border: 1px solid #ccc; box-sizing: border-box;
    }
    .link { stroke: #888; stroke-width: 2px; }
    .node circle {
      fill: hwb(60 15% 79%); stroke: #fff; stroke-width: 2px; cursor: pointer;
    }
    .node.unlocked circle {
      fill: rgb(9, 126, 19); stroke: #fff; stroke-width: 2px;
    }
    .caption {
      font-size: 12px; text-anchor: middle; fill: #ffffff; pointer-events: none;
    }
    .weeks {
      font-size: 10px; text-anchor: middle; fill: #cccccc; pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="top-panel">
    <div>
      Birth Date: <input type="date" id="birthDate" />
    </div>
    <div>
      <button id="importBtn">Import</button>
      <button id="exportBtn">Export</button>
      <input id="importFile" type="file" accept=".json" style="display:none" />
    </div>
  </div>
  <svg id="graph"></svg>

  <script>
    // 1) INITIAL DATA (will be overridden if localStorage or import is used)
    let babyData = [
      {
        "id": 1,
        "title": "Lifts Head",
        "description": "Baby can lift their head briefly when placed on their tummy. Encourage tummy time daily to strengthen neck muscles.",
        "typical_achievement_weeks": 4,
        "follow_up_ids": [2, 3],
        "achievement_time_weeks": null,
        "comment": ""
      },
      {
        "id": 2,
        "title": "Smiles Responsively",
        "description": "Baby smiles in response to your smile or voice. Engage in frequent face-to-face interactions to promote social development.",
        "typical_achievement_weeks": 6,
        "follow_up_ids": [3, 4],
        "achievement_time_weeks": null,
        "comment": ""
      },
      {
        "id": 3,
        "title": "Follows Objects with Eyes",
        "description": "Baby can track moving objects with their eyes. Use colorful toys to help develop visual tracking skills.",
        "typical_achievement_weeks": 8,
        "follow_up_ids": [],
        "achievement_time_weeks": null,
        "comment": ""
      },
      {
        "id": 4,
        "title": "Coos and Gurgles",
        "description": "Baby makes cooing and gurgling sounds. Talk and sing to your baby to encourage early language skills.",
        "typical_achievement_weeks": 8,
        "follow_up_ids": [],
        "achievement_time_weeks": null,
        "comment": ""
      }
    ];

    // Try to load from localStorage
    const saved = localStorage.getItem("babyData");
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed)) babyData = parsed;
      } catch (e) {
        console.warn("Local storage data was corrupt, ignoring it.");
      }
    }

    // 2) D3 SETUP
    const svg = d3.select("#graph");
    const width = window.innerWidth, height = window.innerHeight;
    svg.attr("width", width).attr("height", height);
    const zoomG = svg.append("g");
    const defs = svg.append("defs");
    defs.append("marker")
      .attr("id", "arrowhead")
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 90)
      .attr("refY", 0)
      .attr("markerWidth", 6)
      .attr("markerHeight", 6)
      .attr("orient", "auto")
      .attr("markerUnits", "strokeWidth")
      .append("path")
      .attr("d", "M0,-5L10,0L0,5")
      .attr("fill", "#888");

    svg.call(d3.zoom().on("zoom", (event) => {
      zoomG.attr("transform", event.transform);
    }));

    // Build nodes & links
    function buildGraphData(data) {
      const validIds = new Set(data.map(d => d.id));
      return {
        nodes: data.map(d => ({ ...d })),
        links: data.flatMap(d =>
          d.follow_up_ids
           .filter(fuId => validIds.has(fuId))
           .map(fuId => ({ source: d.id, target: fuId }))
        )
      };
    }

    // 3) RENDERING & SIMULATION
    let simulation, node, link, nodes, links;
    function renderGraph() {
      zoomG.selectAll("*").remove();
      ({ nodes, links } = buildGraphData(babyData));

      simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(200))
        .force("charge", d3.forceManyBody().strength(-4000))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(40));

      link = zoomG.selectAll(".link")
        .data(links).enter().append("line")
        .attr("class", "link")
        .attr("marker-end", "url(#arrowhead)");

      node = zoomG.selectAll(".node")
        .data(nodes).enter().append("g")
        .attr("class", d => "node " + (d.achievement_time_weeks !== null ? "unlocked" : ""))
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended)
        );

      node.append("circle").attr("r", 60).on("click", (_, d) => onNodeClick(d));
      node.append("text").attr("class", "caption").attr("dy", -2).text(d => d.title);
      node.append("text").attr("class", "weeks").attr("dy", 14).text(formatWeeks);

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
      });
    }

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x; d.fy = d.y;
    }
    function dragged(event, d) {
      d.fx = event.x; d.fy = event.y;
    }
    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null; d.fy = null;
    }

    // 4) INTERACTIONS
    function onNodeClick(d) {
      const isUnlocked = d.achievement_time_weeks !== null;
      const action = isUnlocked ? "re-lock or update" : "unlock";
      const promptText = 
        `Title: ${d.title}\n\n${d.description}\n\nTypical: ~week ${d.typical_achievement_weeks}\n` +
        (isUnlocked 
          ? `Currently unlocked at week ${d.achievement_time_weeks}\nComment: ${d.comment}\n\n` +
            `Enter new comment or clear to remove.\nLeave blank to re-lock.\n`
          : `Enter a comment or leave blank.\n`) +
        `\nType something and press OK to ${action}, or press Cancel to do nothing.`;

      const userInput = window.prompt(promptText, isUnlocked ? d.comment : "");
      if (userInput === null) return; // canceled

      if (isUnlocked && userInput === "") {
        d.achievement_time_weeks = null; d.comment = "";
      } else {
        d.comment = userInput;
        const bd = document.getElementById("birthDate").value;
        if (bd) {
          const diffDays = (new Date() - new Date(bd)) / (1000*60*60*24);
          d.achievement_time_weeks = Math.round(diffDays/7);
        } else {
          d.achievement_time_weeks = d.typical_achievement_weeks;
        }
      }
      refreshGraph();
      saveToLocalStorage();
    }

    function refreshGraph() {
      node.attr("class", d => "node " + (d.achievement_time_weeks !== null ? "unlocked" : ""));
      node.select(".weeks").text(formatWeeks);
    }

    function formatWeeks(d) {
      if (d.achievement_time_weeks === null)
        return `~ week ${d.typical_achievement_weeks}`;
      const diff = d.typical_achievement_weeks - d.achievement_time_weeks;
      if (diff > 0) return `Unlocked ${Math.abs(diff)} weeks early!`;
      if (diff < 0) return `Unlocked ${Math.abs(diff)} weeks late.`;
      return `Unlocked right on time!`;
    }

    function saveToLocalStorage() {
      localStorage.setItem("babyData", JSON.stringify(nodes.map(d => ({ 
        id: d.id, title: d.title, description: d.description,
        typical_achievement_weeks: d.typical_achievement_weeks,
        follow_up_ids: d.follow_up_ids,
        achievement_time_weeks: d.achievement_time_weeks,
        comment: d.comment
      }))));
    }

    // 5) IMPORT/EXPORT
    document.getElementById("exportBtn").addEventListener("click", () => {
      const exportData = JSON.stringify(babyData, null, 2);
      const blob = new Blob([exportData], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "babyData_backup.json";
      a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById("importBtn").addEventListener("click", () => {
      document.getElementById("importFile").click();
    });

    document.getElementById("importFile").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const importedData = JSON.parse(ev.target.result);
          if (!Array.isArray(importedData)) return alert("Must be an array of items.");
          babyData = importedData;
          localStorage.setItem("babyData", JSON.stringify(babyData));
          renderGraph();
        } catch {
          alert("Error parsing JSON. Check file format.");
        }
      };
      reader.readAsText(file);
      e.target.value = null;
    });

    // 6) INITIAL RENDER
    renderGraph();
  </script>
</body>
</html>