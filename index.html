<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Support Bubble Demo</title>
<style>
  /* —— Bubble —— */
  #support-bubble {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #007bff; /* blue */
    color: #ffffff;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    z-index: 10000;
  }
  #support-bubble:hover {
    opacity: 0.9;
  }
  /* —— Pop‑over —— */
  #support-popover {
    position: fixed;
    bottom: 90px; /* bubble height + margin */
    right: 24px;
    width: 320px;
    background: #ffffff;
    border: 1px solid #d0d0d0;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    padding: 12px;
    display: none;
    z-index: 10000;
  }
  #support-popover textarea {
    width: 100%;
    min-height: 80px;
    resize: vertical;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 6px;
    font-family: inherit;
    font-size: 14px;
    box-sizing: border-box;
  }
  #support-send {
    margin-top: 8px;
    width: 100%;
    padding: 8px 0;
    border: none;
    border-radius: 4px;
    background: #007bff;
    color: #fff;
    font-size: 14px;
    cursor: pointer;
  }
  #support-send:hover {
    opacity: 0.9;
  }
</style>
</head>
<body>
  <!-- —— Bubble —— -->
  <div id="support-bubble" title="Ask question or report bugs or feature requests">
    <!-- simple chat icon (SVG) -->
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
    </svg>
  </div>

  <!-- —— Pop‑over —— -->
  <div id="support-popover">
    <textarea id="support-input" placeholder="Type your question, bug report, or feature request…"></textarea>
    <button id="support-send">Send to ChatGPT</button>
  </div>

<script>
/**********************
 * Configuration
 **********************/
const GITHUB_URL = "https://github.com/your/repo"; // ← Replace with your repo
const CHAR_LIMIT = 2000; // post‑encoding limit

/**********************
 * Console log capture
 **********************/
(function captureConsole() {
  const methods = ["log", "error", "warn", "info"];
  const original = {};
  const buffer = [];

  methods.forEach(m => {
    original[m] = console[m];
    console[m] = function(...args) {
      try {
        const line = `[${m.toUpperCase()}] "${args.map(a => (typeof a === "string" ? a : JSON.stringify(a))).join(" ")}"`;
        buffer.push(line);
      } catch (_) {/* ignore serialization issues */}
      original[m].apply(console, args);
    };
  });

  window.__supportLogs = buffer;
})();

/**********************
 * UI behaviour
 **********************/
const bubble   = document.getElementById("support-bubble");
const popover  = document.getElementById("support-popover");
const textarea = document.getElementById("support-input");
const sendBtn  = document.getElementById("support-send");

function togglePopover() {
  if (popover.style.display === "none" || !popover.style.display) {
    popover.style.display = "block";
    textarea.focus();
  } else {
    popover.style.display = "none";
  }
}

bubble.addEventListener("click", togglePopover);

document.addEventListener("keydown", e => {
  if (e.key === "Escape") popover.style.display = "none";
});

function buildPrompt(userText, consoleLog) {
  const prefix = `Here is some user information related to the application at ${GITHUB_URL} (take a look at the code and readme to learn what this app does).\n\nIn case the provided user information sounds like question on how to do something or how something works use these rules:\nTake as much context as possible (especially from the github repo) to help the user as well as you can.\n\nIn case the provided user information sounds like an bug report or a feature request use these rules:\nYour task is to write a well structured github issue with a focus on the underlying user story.\n\nTo get to the fundamental goal for the issue, review if the provided user information already answers the \"5 Whys\" and if not ask me one question at a time until you have all information needed for the issue.\n\nProvide the full text for the issue in raw markdown notation (for copy paste) and since you reviewed the code, feel free to also include a section with an implementation suggestion, if applicable.\n\nHere is the provided user information:\n`;

  let prompt = `${prefix}${userText}\n\nConsole log:\n${consoleLog}`;

  // Encoding length helper
  const encodedLength = str => encodeURIComponent(str).length;

  // Trim console log until total ≤ limit
  if (encodedLength(prompt) > CHAR_LIMIT) {
    let trimmedLog = consoleLog;
    while (encodedLength(prompt) > CHAR_LIMIT && trimmedLog.length > 0) {
      // drop first 200 characters at a time
      trimmedLog = trimmedLog.slice(200);
      prompt = `${prefix}${userText}\n\nConsole log:\n${trimmedLog}...`;
    }
  }

  return prompt;
}

function sendToChatGPT() {
  const userText = textarea.value.trim();
  if (!userText) return;

  const consoleLog = window.__supportLogs.join("\n");
  const prompt = buildPrompt(userText, consoleLog);

  const url = `https://chat.openai.com/?q=${encodeURIComponent(prompt)}`;
  window.open(url, "_blank", "noopener");
  textarea.value = ""; // reset
  popover.style.display = "none";
}

sendBtn.addEventListener("click", sendToChatGPT);

// allow Ctrl+Enter to send
textarea.addEventListener("keydown", e => {
  if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
    sendToChatGPT();
  }
});
</script>
</body>
</html>