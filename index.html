<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BabyStepsJs</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden;
      background-color: #1e1e2f; font-family: Arial, sans-serif;
    }

    /* TOP PANEL */
    .top-panel {
      position: absolute; width: 100%; text-align: center; top: 10px;
      z-index: 999; color: white; font-size: 14px; display: flex;
      justify-content: center; align-items: center; gap: 20px;
    }
    .top-panel input[type="date"] {
      color: black; padding: 5px 8px; border-radius: 5px; border: none;
    }
    .top-panel button {
      cursor: pointer; padding: 5px 10px; border-radius: 5px; border: none;
      background-color: #4caf50; color: white; font-weight: bold;
    }
    .top-panel button:hover { background-color: #388e3c; }
    .top-panel input#importFile { display: none; }

    /* SIDE PANEL */
    .side-panel {
      position: absolute; top: 60px; right: 0; width: 300px;
      height: calc(100% - 60px); background-color: #2c2c3e; color: #fff;
      border-left: 1px solid #444; padding: 20px; box-sizing: border-box;
      display: none; flex-direction: column; gap: 10px; font-size: 14px;
    }
    .side-panel h2 { margin: 0; font-size: 16px; }
    .side-panel textarea {
      width: 100%; height: 80px; resize: vertical; border: none;
      border-radius: 4px; font-family: Arial, sans-serif; padding: 5px;
    }
    .side-panel input[type="date"], .side-panel button {
      margin-top: 5px; padding: 5px; border-radius: 4px; border: none; color: black;
    }
    .side-panel button.save-btn {
      background-color: #4caf50; color: white; font-weight: bold;
      cursor: pointer; width: 100%;
    }
    .side-panel button.save-btn:hover { background-color: #388e3c; }

    /* MAIN SVG */
    svg {
      width: 100%; height: 100vh; box-sizing: border-box;
    }
    .link {
      stroke: #888; stroke-width: 2px; marker-end: url(#arrowhead);
    }
    .node circle {
      fill: hwb(60 15% 79%); stroke: #fff; stroke-width: 2px; cursor: pointer;
    }
    .node.unlocked circle {
      fill: rgb(9, 126, 19); /* already unlocked */
    }
    .node.overdue circle {
      fill: #a83232; /* if current age > typical_achievement_weeks & still locked */
    }
    .node.next circle {
      fill: #5c50d0; /* next in line if all parents are unlocked */
    }
    .caption {
      font-size: 12px; text-anchor: middle; fill: #ffffff;
      pointer-events: none; /* ignoring pointer so node circle gets the click */
    }
    .weeks {
      font-size: 10px; text-anchor: middle; fill: #cccccc;
      pointer-events: none; transform: translateY(16px);
    }
  </style>
</head>
<body>

  <!-- TOP PANEL -->
  <div class="top-panel">
    <div>
      Birth Date:
      <input type="date" id="birthDate" />
    </div>
    <div>
      <button id="importBtn">Import</button>
      <button id="exportBtn">Export</button>
      <input id="importFile" type="file" accept=".json" />
    </div>
  </div>

  <!-- SIDE PANEL -->
  <div class="side-panel" id="sidePanel">
    <h2 id="sidePanelTitle"></h2>
    <div id="sidePanelDescription" style="font-size: 12px; color: #ccc;"></div>
    <label for="sidePanelAchievementDate">Date Unlocked (optional):</label>
    <input type="date" id="sidePanelAchievementDate" />
    <label for="sidePanelComment">Comment:</label>
    <textarea id="sidePanelComment"
              placeholder="Enter any notes or observations..."></textarea>
    <button class="save-btn" id="sidePanelSaveBtn">Save</button>
  </div>

  <!-- MAIN SVG -->
  <svg id="graph"></svg>

  <script>
    // 1) INITIAL DATA (will be overridden if localStorage or imported)
    let babyData = [
      {
        "id": 1,
        "title": "Lifts Head",
        "description": "Baby can lift their head briefly when placed on their tummy. Encourage tummy time daily to strengthen neck muscles.",
        "typical_achievement_weeks": 4,
        "follow_up_ids": [2, 3],
        "achievement_time_weeks": null,
        "comment": ""
      },
      {
        "id": 2,
        "title": "Smiles Responsively",
        "description": "Baby smiles in response to your smile or voice. Engage in frequent face-to-face interactions to promote social development.",
        "typical_achievement_weeks": 6,
        "follow_up_ids": [3, 4],
        "achievement_time_weeks": null,
        "comment": ""
      },
      {
        "id": 3,
        "title": "Follows Objects with Eyes",
        "description": "Baby can track moving objects with their eyes. Use colorful toys to help develop visual tracking skills.",
        "typical_achievement_weeks": 8,
        "follow_up_ids": [],
        "achievement_time_weeks": null,
        "comment": ""
      },
      {
        "id": 4,
        "title": "Coos and Gurgles",
        "description": "Baby makes cooing and gurgling sounds. Talk and sing to your baby to encourage early language skills.",
        "typical_achievement_weeks": 8,
        "follow_up_ids": [],
        "achievement_time_weeks": null,
        "comment": ""
      }
    ];

    // Attempt to load data from localStorage
    const savedData = localStorage.getItem("babyData");
    if (savedData) {
      try {
        const parsed = JSON.parse(savedData);
        if (Array.isArray(parsed)) babyData = parsed;
      } catch (e) {
        console.warn("Local storage babyData was corrupt, ignoring it.");
      }
    }

    // Attempt to load birthDate from localStorage
    const savedBirthDate = localStorage.getItem("birthDate");
    if (savedBirthDate) {
      document.getElementById("birthDate").value = savedBirthDate;
    }

    // 2) D3 SETUP
    const svg = d3.select("#graph");
    const width = window.innerWidth, height = window.innerHeight;
    svg.attr("width", width).attr("height", height);

    // Pan & zoom group
    const zoomG = svg.append("g");

    // Arrowhead definition
    const defs = svg.append("defs");
    defs.append("marker")
      .attr("id", "arrowhead")
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 90)
      .attr("refY", 0)
      .attr("markerWidth", 6)
      .attr("markerHeight", 6)
      .attr("orient", "auto")
      .attr("markerUnits", "strokeWidth")
      .append("path")
      .attr("d", "M0,-5L10,0L0,5")
      .attr("fill", "#888");

    svg.call(d3.zoom().on("zoom", (event) => {
      zoomG.attr("transform", event.transform);
    }));

    // Prepare nodes & links from babyData
    function buildGraphData(data) {
      const validIds = new Set(data.map(d => d.id));
      return {
        nodes: data.map(d => ({ ...d })),
        links: data.flatMap(d =>
          d.follow_up_ids
            .filter(fuId => validIds.has(fuId))
            .map(fuId => ({ source: d.id, target: fuId }))
        )
      };
    }

    // 3) RENDERING & SIMULATION
    let simulation, node, link, nodes, links;
    function renderGraph() {
      zoomG.selectAll("*").remove();
      const graphData = buildGraphData(babyData);
      nodes = graphData.nodes;
      links = graphData.links;

      // Setup force simulation
      simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(200))
        .force("charge", d3.forceManyBody().strength(-4000))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(50));

      // Draw links
      link = zoomG.selectAll(".link")
        .data(links)
        .enter().append("line")
        .attr("class", "link");

      // Draw nodes
      node = zoomG.selectAll(".node")
        .data(nodes)
        .enter().append("g")
        .attr("class", "node")
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended)
        );

      node.append("circle")
        .attr("r", 60)
        .on("click", (event, d) => {
          event.stopPropagation(); // so it doesn’t trigger “outside click”
          onNodeClick(d);
        });

      node.append("text")
        .attr("class", "caption")
        .text(d => d.title)
        .each(function(d) { wrapText(d3.select(this), 100); });

      node.append("text")
        .attr("class", "weeks")
        .text(formatWeeks);

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
      });

      refreshGraph(); // apply coloring states
    }

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x; d.fy = d.y;
    }
    function dragged(event, d) {
      d.fx = event.x; d.fy = event.y;
    }
    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null; d.fy = null;
    }

    // Simple text-wrap function for node titles
    function wrapText(textSelection, width) {
      textSelection.each(function() {
        const text = d3.select(this);
        const words = text.text().split(/\s+/).reverse();
        let line = [];
        let lineNumber = 0;
        const lineHeight = 1.2; // em
        const y = text.attr("y") || 0;
        const x = text.attr("x") || 0;
        let tspan = text.text(null)
          .append("tspan")
          .attr("x", x)
          .attr("y", y)
          .attr("dy", 0 + "em");
        let word;
        while ((word = words.pop())) {
          line.push(word);
          tspan.text(line.join(" "));
          if (tspan.node().getComputedTextLength() > width) {
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            tspan = text.append("tspan")
              .attr("x", x).attr("y", y)
              .attr("dy", ++lineNumber * lineHeight + "em")
              .text(word);
          }
        }
        // Center text vertically in circle (roughly)
        const totalLines = lineNumber + 1;
        const offset = -0.6 * totalLines;
        text.selectAll("tspan")
          .attr("dy", function(d, i) {
            return (i + offset) * lineHeight + "em";
          });
      });
    }

    // 4) LOGIC FOR COLORING & “NEXT” / “OVERDUE”
    function refreshGraph() {
      const bd = document.getElementById("birthDate").value;
      let ageInWeeks = null;
      if (bd) {
        const diffDays = (new Date() - new Date(bd)) / (1000 * 60 * 60 * 24);
        ageInWeeks = Math.round(diffDays / 7);
      }

      node
        .classed("unlocked", d => d.achievement_time_weeks !== null)
        .classed("overdue", d => {
          if (!ageInWeeks) return false;
          return d.achievement_time_weeks === null && ageInWeeks > d.typical_achievement_weeks;
        })
        .classed("next", d => {
          // "next" if still locked but all parents are unlocked
          if (d.achievement_time_weeks !== null) return false;
          const parents = babyData.filter(p => p.follow_up_ids.includes(d.id));
          if (parents.length === 0) return true; // no parents => immediately next
          return parents.every(p => p.achievement_time_weeks !== null);
        });

      // Update weeks text
      node.select(".weeks").text(formatWeeks);
    }

    function formatWeeks(d) {
      if (d.achievement_time_weeks === null) {
        return `~ week ${d.typical_achievement_weeks}`;
      }
      const diff = d.typical_achievement_weeks - d.achievement_time_weeks;
      if (diff > 0) return `Unlocked ${Math.abs(diff)} weeks early`;
      if (diff < 0) return `Unlocked ${Math.abs(diff)} weeks late`;
      return `Unlocked right on time`;
    }

    // 5) SIDE PANEL
    let currentNode = null;
    const sidePanel = document.getElementById("sidePanel");
    const titleEl = document.getElementById("sidePanelTitle");
    const descEl = document.getElementById("sidePanelDescription");
    const dateEl = document.getElementById("sidePanelAchievementDate");
    const commentEl = document.getElementById("sidePanelComment");
    const saveBtn = document.getElementById("sidePanelSaveBtn");

    saveBtn.addEventListener("click", () => {
      if (!currentNode) return;

      // If user provided a date, compute baby’s age in weeks at that date
      const achievementDate = dateEl.value ? new Date(dateEl.value) : null;
      const birthDateStr = document.getElementById("birthDate").value;
      if (achievementDate && birthDateStr) {
        const bd = new Date(birthDateStr);
        const diffDays = (achievementDate - bd) / (1000 * 60 * 60 * 24);
        currentNode.achievement_time_weeks = diffDays > 0
          ? Math.round(diffDays / 7)
          : 0; // if negative, set 0 as a fallback
      } else if (achievementDate && !birthDateStr) {
        // No birth date => fallback to typical
        currentNode.achievement_time_weeks = currentNode.typical_achievement_weeks;
      } else {
        // No date => treat as locked again
        currentNode.achievement_time_weeks = null;
      }

      currentNode.comment = commentEl.value.trim();
      refreshGraph();
      saveToLocalStorage();
      hideSidePanel();
    });

    // Show side panel and fill data
    function onNodeClick(d) {
      currentNode = d;
      titleEl.textContent = d.title;
      descEl.textContent = d.description;
      commentEl.value = d.comment || "";

      // If locked, fill today's date
      // If unlocked, guess date from birthDate + achievement_time_weeks
      const birthDateStr = document.getElementById("birthDate").value;
      if (d.achievement_time_weeks === null) {
        // locked => default to today's date
        const now = new Date();
        dateEl.value = now.toISOString().split("T")[0];
      } else if (birthDateStr) {
        const bd = new Date(birthDateStr);
        const guessDate = new Date(bd);
        guessDate.setDate(guessDate.getDate() + (7 * d.achievement_time_weeks));
        dateEl.value = guessDate.toISOString().split("T")[0];
      } else {
        // no birth date to guess from, just clear
        dateEl.value = "";
      }

      sidePanel.style.display = "flex";
    }

    function hideSidePanel() {
      sidePanel.style.display = "none";
      currentNode = null;
    }

    // Hide side panel if user clicks outside it
    document.addEventListener("click", (event) => {
      const isClickInside = sidePanel.contains(event.target);
      if (!isClickInside) {
        hideSidePanel();
      }
    });

    // 6) SAVE TO LOCAL STORAGE
    function saveToLocalStorage() {
      localStorage.setItem("babyData", JSON.stringify(nodes.map(d => ({
        id: d.id,
        title: d.title,
        description: d.description,
        typical_achievement_weeks: d.typical_achievement_weeks,
        follow_up_ids: d.follow_up_ids,
        achievement_time_weeks: d.achievement_time_weeks,
        comment: d.comment
      }))));

      const bd = document.getElementById("birthDate").value;
      if (bd) {
        localStorage.setItem("birthDate", bd);
      } else {
        localStorage.removeItem("birthDate");
      }
    }

    // 7) IMPORT / EXPORT
    document.getElementById("exportBtn").addEventListener("click", () => {
      // Prepare data for export (the entire tech tree + states)
      const exportData = JSON.stringify(babyData, null, 2);
      const blob = new Blob([exportData], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "babyData_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById("importBtn").addEventListener("click", () => {
      document.getElementById("importFile").click();
    });

    document.getElementById("importFile").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const importedData = JSON.parse(ev.target.result);
          if (!Array.isArray(importedData)) {
            alert("JSON must be an array of items.");
            return;
          }
          babyData = importedData;
          localStorage.setItem("babyData", JSON.stringify(babyData));
          renderGraph();
        } catch (err) {
          alert("Error parsing JSON. Check file format.");
        }
      };
      reader.readAsText(file);
      e.target.value = null;
    });

    // 8) RE-RENDER ON BIRTHDATE CHANGE
    document.getElementById("birthDate").addEventListener("change", () => {
      saveToLocalStorage();
      refreshGraph();
    });

    // 9) INITIAL RENDER
    renderGraph();
  </script>
</body>
</html>